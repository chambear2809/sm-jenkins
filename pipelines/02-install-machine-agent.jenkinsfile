// Pipeline: Install Machine Agent
// Description: Installs Machine Agent using smartagentctl across multiple EC2 hosts

pipeline {
    agent {
        label 'linux'
    }
    
    parameters {
        string(
            name: 'BATCH_SIZE',
            defaultValue: '256',
            description: 'Number of hosts to process per batch'
        )
        string(
            name: 'SSH_USER',
            defaultValue: 'ubuntu',
            description: 'SSH username for target hosts'
        )
    }
    
    environment {
        FAIL_FILE = "/tmp/failed_hosts_${BUILD_ID}"
        KEY_FILE = "${HOME}/.ssh/id_rsa_build_${BUILD_ID}"
        AGENT_TYPE = "machine"
        OPERATION = "install"
    }
    
    stages {
        stage('Prepare') {
            steps {
                script {
                    prepareBatches()
                }
            }
        }
        
        stage('Process Batches') {
            steps {
                script {
                    processBatches()
                }
            }
        }
        
        stage('Summary') {
            steps {
                script {
                    printSummary("Machine Agent Installation")
                }
            }
        }
    }
    
    post {
        always {
            script {
                cleanup()
            }
        }
    }
}

def prepareBatches() {
    echo "ðŸ“Š Preparing ${env.AGENT_TYPE} agent ${env.OPERATION}..."
    
    withCredentials([string(credentialsId: 'deployment-hosts', variable: 'DEPLOYMENT_HOSTS')]) {
        sh '''
            set -euo pipefail
            HOSTS=$(printf '%s\\n' "$DEPLOYMENT_HOSTS" | tr -d '\\r' | grep -v '^\\s*$' || true)
            TOTAL=$(printf '%s\\n' "$HOSTS" | wc -l | xargs || echo 0)
            echo "total_hosts=$TOTAL" > ${WORKSPACE}/batch_info.txt
            
            if [ "${TOTAL:-0}" -eq 0 ]; then
                echo "total_batches=0" >> ${WORKSPACE}/batch_info.txt
                echo "â„¹ï¸ No hosts provided."
                exit 1
            fi
            
            TOTAL_BATCHES=$(( (TOTAL + BATCH_SIZE - 1) / BATCH_SIZE ))
            echo "total_batches=$TOTAL_BATCHES" >> ${WORKSPACE}/batch_info.txt
            printf '%s\\n' "$HOSTS" > ${WORKSPACE}/all_hosts.txt
            
            echo "ðŸ“Š Processing $TOTAL hosts across $TOTAL_BATCHES batches"
        '''
    }
    
    def batchInfo = readFile("${WORKSPACE}/batch_info.txt")
    env.TOTAL_HOSTS = batchInfo.find(/total_hosts=(\d+)/) { match, num -> num }
    env.TOTAL_BATCHES = batchInfo.find(/total_batches=(\d+)/) { match, num -> num }
    
    if (env.TOTAL_BATCHES == '0') {
        error("No hosts to process")
    }
}

def processBatches() {
    def totalBatches = env.TOTAL_BATCHES as Integer
    def batchSize = params.BATCH_SIZE as Integer
    
    for (int i = 0; i < totalBatches; i++) {
        def batchNum = i + 1
        
        stage("${env.OPERATION.capitalize()} Batch ${batchNum}/${totalBatches}") {
            echo "ðŸš€ Processing batch ${batchNum} of ${totalBatches}"
            
            sh """
                head -n \$(( ${batchNum} * ${batchSize} )) ${WORKSPACE}/all_hosts.txt | \
                tail -n ${batchSize} > ${WORKSPACE}/batch_${batchNum}.txt
            """
            
            processAgentBatch(batchNum)
        }
    }
}

def processAgentBatch(batchNum) {
    withCredentials([sshUserPrivateKey(credentialsId: 'ssh-private-key', keyFileVariable: 'SSH_KEY_FILE')]) {
        sh """
            set -euo pipefail
            
            mkdir -p \$(dirname ${env.KEY_FILE})
            cp \$SSH_KEY_FILE ${env.KEY_FILE}
            chmod 600 ${env.KEY_FILE}
            
            BATCH_SIZE=\$(wc -l < ${WORKSPACE}/batch_${batchNum}.txt | xargs)
            echo "ðŸš€ ${env.OPERATION.capitalize()}ing ${env.AGENT_TYPE} agent on batch of \$BATCH_SIZE hosts"
            
            while IFS= read -r HOST; do
                (
                    echo "ðŸ“¡ ${env.OPERATION.capitalize()}ing ${env.AGENT_TYPE} agent on \$HOST"
                    
                    if ssh -i ${env.KEY_FILE} \
                          -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=30 \
                          "${params.SSH_USER}@\${HOST}" \
                          "cd /opt/appdynamics/appdsmartagent && sudo ./smartagentctl ${env.OPERATION} ${env.AGENT_TYPE}"; then
                        echo "âœ… Completed ${env.AGENT_TYPE} agent ${env.OPERATION} on \$HOST"
                    else
                        echo "âŒ Failed to ${env.OPERATION} ${env.AGENT_TYPE} agent on \$HOST" >&2
                        echo "\$HOST" >> ${env.FAIL_FILE}
                    fi
                ) &
            done < ${WORKSPACE}/batch_${batchNum}.txt
            
            wait
            echo "âœ… Batch ${batchNum} complete"
        """
    }
}

def printSummary(title) {
    echo "ðŸ“Š ${title} Summary"
    echo "=" * (title.length() + 13)
    echo "Total hosts: ${env.TOTAL_HOSTS}"
    echo "Total batches: ${env.TOTAL_BATCHES}"
    echo "Batch size: ${params.BATCH_SIZE}"
    
    if (fileExists(env.FAIL_FILE)) {
        def failedHosts = readFile(env.FAIL_FILE)
        echo "âŒ Failed hosts:"
        echo failedHosts
        currentBuild.result = 'FAILURE'
    } else {
        echo "âœ… All operations completed successfully"
    }
}

def cleanup() {
    sh """
        rm -f ${env.KEY_FILE}
        rm -f ${WORKSPACE}/all_hosts.txt
        rm -f ${WORKSPACE}/batch_*.txt
        rm -f ${WORKSPACE}/batch_info.txt
        rm -f ${env.FAIL_FILE}
    """
}
